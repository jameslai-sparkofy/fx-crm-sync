<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX CRM 同步管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="adminApp()" x-cloak>
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <h1 class="text-2xl font-bold text-gray-900">紛享銷客 CRM 同步管理系統</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-500">最後更新: <span x-text="lastUpdate"></span></span>
                        <button @click="refreshData()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                            重新載入
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">商機總數</h3>
                    <p class="text-3xl font-bold text-blue-600" x-text="stats.opportunities"></p>
                    <p class="text-sm text-gray-500 mt-1">NewOpportunityObj</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">案場總數</h3>
                    <p class="text-3xl font-bold text-green-600" x-text="stats.sites"></p>
                    <p class="text-sm text-gray-500 mt-1">object_8W9cb__c</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">同步記錄</h3>
                    <p class="text-3xl font-bold text-purple-600" x-text="stats.syncLogs"></p>
                    <p class="text-sm text-gray-500 mt-1">總執行次數</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
                        <button 
                            @click="activeTab = 'sync'" 
                            :class="activeTab === 'sync' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm transition"
                        >
                            同步管理
                        </button>
                        <button 
                            @click="activeTab = 'logs'" 
                            :class="activeTab === 'logs' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm transition"
                        >
                            同步日誌
                        </button>
                        <button 
                            @click="activeTab = 'objects'" 
                            :class="activeTab === 'objects' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                            class="py-4 px-1 border-b-2 font-medium text-sm transition"
                        >
                            對象管理
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="p-6">
                    <!-- Sync Management Tab -->
                    <div x-show="activeTab === 'sync'" class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">手動同步</h2>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Opportunities Sync -->
                            <div class="border rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">商機同步</h3>
                                <p class="text-sm text-gray-600 mb-4">同步 CRM 中的商機數據到 D1 資料庫</p>
                                <div class="space-y-3">
                                    <button 
                                        @click="syncData('NewOpportunityObj', false)"
                                        :disabled="syncing.opportunities"
                                        class="w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                    >
                                        <span x-show="!syncing.opportunities">增量同步</span>
                                        <span x-show="syncing.opportunities">同步中...</span>
                                    </button>
                                    <button 
                                        @click="syncData('NewOpportunityObj', true)"
                                        :disabled="syncing.opportunities"
                                        class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                    >
                                        <span x-show="!syncing.opportunities">完整同步</span>
                                        <span x-show="syncing.opportunities">同步中...</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Sites Sync -->
                            <div class="border rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">案場同步</h3>
                                <p class="text-sm text-gray-600 mb-4">同步 CRM 中的案場數據到 D1 資料庫</p>
                                <div class="space-y-3">
                                    <button 
                                        @click="syncData('object_8W9cb__c', false)"
                                        :disabled="syncing.sites"
                                        class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                    >
                                        <span x-show="!syncing.sites">增量同步</span>
                                        <span x-show="syncing.sites">同步中...</span>
                                    </button>
                                    <button 
                                        @click="syncData('object_8W9cb__c', true)"
                                        :disabled="syncing.sites"
                                        class="w-full px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition"
                                    >
                                        <span x-show="!syncing.sites">完整同步</span>
                                        <span x-show="syncing.sites">同步中...</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Sync Result -->
                        <div x-show="syncResult" class="mt-6 p-4 rounded-lg" :class="syncResult?.success ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'">
                            <h4 class="font-medium" :class="syncResult?.success ? 'text-green-800' : 'text-red-800'">
                                <span x-text="syncResult?.success ? '同步成功' : '同步失敗'"></span>
                            </h4>
                            <p class="mt-1 text-sm" :class="syncResult?.success ? 'text-green-700' : 'text-red-700'" x-text="syncResult?.message"></p>
                        </div>
                    </div>

                    <!-- Logs Tab -->
                    <div x-show="activeTab === 'logs'" class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">同步日誌</h2>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">時間</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">對象</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">狀態</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">成功數量</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">錯誤數量</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    <template x-for="log in recentLogs" :key="log.sync_id">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(log.completed_at)"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="getObjectName(log.entity_type)"></td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span 
                                                    class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                                    :class="log.status === 'COMPLETED' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                                    x-text="log.status === 'COMPLETED' ? '成功' : '失敗'"
                                                ></span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="log.records_count - log.error_count"></td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="log.error_count"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Objects Tab -->
                    <div x-show="activeTab === 'objects'" class="space-y-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-4">對象管理</h2>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                對象選擇和欄位檢測功能正在開發中...
                            </p>
                        </div>

                        <div class="space-y-4">
                            <div class="border rounded-lg p-6">
                                <h3 class="text-lg font-medium text-gray-900 mb-2">已同步對象</h3>
                                <ul class="space-y-2 mt-4">
                                    <li class="flex items-center justify-between py-2">
                                        <span class="text-gray-700">商機 (NewOpportunityObj)</span>
                                        <span class="text-sm text-gray-500">61 個欄位</span>
                                    </li>
                                    <li class="flex items-center justify-between py-2">
                                        <span class="text-gray-700">案場 (object_8W9cb__c)</span>
                                        <span class="text-sm text-gray-500">47 個欄位</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function adminApp() {
            return {
                activeTab: 'sync',
                lastUpdate: new Date().toLocaleString('zh-TW'),
                stats: {
                    opportunities: 0,
                    sites: 0,
                    syncLogs: 0
                },
                syncing: {
                    opportunities: false,
                    sites: false
                },
                syncResult: null,
                recentLogs: [],
                
                // API Configuration
                syncApiUrl: 'https://fx-crm-sync.lai-jameslai.workers.dev',
                
                init() {
                    this.loadStats();
                    this.loadRecentLogs();
                },
                
                async loadStats() {
                    try {
                        const response = await fetch(`${this.syncApiUrl}/api/debug/d1-stats`);
                        const data = await response.json();
                        if (data.success) {
                            this.stats = data.data.tables;
                        }
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },
                
                async loadRecentLogs() {
                    try {
                        const response = await fetch(`${this.syncApiUrl}/api/debug/d1-stats`);
                        const data = await response.json();
                        if (data.success) {
                            this.recentLogs = data.data.recentSyncs || [];
                        }
                    } catch (error) {
                        console.error('Failed to load logs:', error);
                    }
                },
                
                async syncData(objectName, fullSync = false) {
                    const syncType = objectName === 'NewOpportunityObj' ? 'opportunities' : 'sites';
                    this.syncing[syncType] = true;
                    this.syncResult = null;
                    
                    try {
                        const endpoint = fullSync ? 'full' : 'start';
                        const response = await fetch(`${this.syncApiUrl}/api/sync/${objectName}/${endpoint}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        const data = await response.json();
                        
                        this.syncResult = {
                            success: data.success,
                            message: data.success 
                                ? `同步完成！成功: ${data.data?.result?.success || 0} 條，錯誤: ${data.data?.result?.errors || 0} 條`
                                : `同步失敗: ${data.error}`
                        };
                        
                        // Reload stats after sync
                        if (data.success) {
                            await this.loadStats();
                            await this.loadRecentLogs();
                        }
                    } catch (error) {
                        this.syncResult = {
                            success: false,
                            message: `同步失敗: ${error.message}`
                        };
                    } finally {
                        this.syncing[syncType] = false;
                    }
                },
                
                async refreshData() {
                    this.lastUpdate = new Date().toLocaleString('zh-TW');
                    await this.loadStats();
                    await this.loadRecentLogs();
                },
                
                formatDate(timestamp) {
                    if (!timestamp) return '-';
                    return new Date(timestamp).toLocaleString('zh-TW');
                },
                
                getObjectName(apiName) {
                    const names = {
                        'NewOpportunityObj': '商機',
                        'object_8W9cb__c': '案場'
                    };
                    return names[apiName] || apiName;
                }
            };
        }
    </script>
</body>
</html>