# R2 圖片儲存與自動結構更新說明

## R2 圖片儲存

### 什麼是 R2？
Cloudflare R2 是物件儲存服務，類似於：
- AWS S3
- Google Cloud Storage
- Azure Blob Storage

用於儲存圖片、檔案等二進制數據，不適合放在資料庫中的大型檔案。

### 已完成配置
- ✅ 創建了 R2 bucket：`fx-crm-images`
- ✅ 整合到 Worker 中
- ✅ 自動處理 CRM 中的圖片欄位

### 圖片處理流程
1. 同步時檢測圖片類型欄位
2. 自動下載圖片到 R2
3. 在 D1 中儲存 R2 的檔案路徑
4. 原始 URL 仍保留作為備份

### R2 儲存結構
```
fx-crm-images/
├── crm-images/
│   ├── {記錄ID}/
│   │   ├── {欄位名稱}_時間戳.jpg
│   │   └── {欄位名稱}_時間戳.png
```

### 成本優勢
- R2 **沒有流量費用**（與 S3 不同）
- 只收儲存費用
- 前 10GB 免費
- 適合圖片等經常被訪問的檔案

## 自動結構更新

### 安全策略
系統現在會：
- ✅ **自動新增欄位**（安全操作）
- ⚠️ **不會**自動刪除欄位（避免數據丟失）
- ⚠️ **不會**自動修改欄位類型（可能造成數據問題）

### 自動新增欄位的情況
當 CRM 中新增欄位時，系統會：
1. 檢測到新欄位
2. 自動執行 `ALTER TABLE ADD COLUMN`
3. 使用適當的預設值
4. 記錄更新日誌

### 需要手動處理的情況
1. **刪除欄位**
   - 系統會通知但不執行
   - 需要確認沒有應用依賴此欄位
   - 手動執行刪除操作

2. **修改欄位類型**
   - 例如從文字改為數字
   - 需要考慮數據轉換
   - 手動處理確保數據完整性

### 查看結構變更
```bash
# 查看欄位變更記錄
GET /api/objects/{objectApiName}/field-change-logs

# 查看結構更新記錄
GET /api/schema/update-logs
```

## 配置公開訪問（可選）

如果需要圖片公開訪問，可以：

1. 在 Cloudflare Dashboard 設定 R2 bucket 的自訂域名
2. 設定環境變數：
```bash
wrangler secret put R2_PUBLIC_DOMAIN
# 輸入: https://images.yourdomain.com
```

3. 圖片就可以通過公開 URL 訪問：
```
https://images.yourdomain.com/crm-images/記錄ID/欄位名稱.jpg
```

## 注意事項

1. **圖片同步可能較慢**
   - 需要下載原始圖片
   - 建議在離峰時間執行完整同步

2. **儲存空間**
   - 定期清理不需要的圖片
   - 可設定生命週期規則自動刪除舊圖片

3. **欄位變更**
   - 新增欄位立即生效
   - 刪除欄位需要評估影響
   - 定期檢查變更日誌